name: Release Preid

# Concurrency control to prevent multiple preid releases running simultaneously
# Cancels in-progress releases when new commits are pushed
concurrency:
  group: push-release-${{ github.ref }}
  cancel-in-progress: true

# Permissions required for publishing packages
permissions:
  contents: write

on:
  push:
    branches:
      # Branch naming pattern: feat/{PREID}/whatever
      # Example: feat/alpha/main, feat/beta/my-feature, feat/rc/test
      - feat/preid/whatever

jobs:
  # Job 1: Parse preid from branch name
  parse-preid:
    name: Parse preid from branch
    runs-on: ubuntu-latest
    env:
      BRANCH: ${{ github.ref_name }}
    outputs:
      preid: ${{ steps.output_preid.outputs.preid }}
    steps:
      - id: output_preid
        run: |
          PREID=$(echo $BRANCH | tr -cd '[:alnum:]_\-/.' | cut -d \/ -f 2)
          echo "preid=$PREID" >> $GITHUB_OUTPUT
          echo "Extracted preid from branch: $PREID"

  # Job 2: Validate preid against forbidden list
  validate-preid:
    runs-on: ubuntu-latest
    needs: parse-preid
    steps:
      - name: Validate preid
        env:
          PREID: ${{ needs.parse-preid.outputs.preid }}
          FORBIDDEN_PREIDS: latest next unstable stable-5 stable-4
        run: |
          echo "Testing to see if $PREID is in the forbidden list ($FORBIDDEN_PREIDS)"
          for e in $FORBIDDEN_PREIDS; do 
            [[ $PREID == $e ]] && echo "ERROR: $PREID is forbidden from preid release" && exit 1
          done
          
          echo "SUCCESS: $PREID is allowed for preid release"

  # Job 3: Publish prerelease packages
  preid-release:
    runs-on: ubuntu-latest
    needs: 
      - parse-preid
      - validate-preid
    steps:
      - name: Checkout repository
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1
        with:
          path: amplify-js

      - name: Setup node and build the repository
        uses: ./amplify-js/.github/actions/node-and-build

      - name: Publish to @preid
        uses: changesets/action@aba318e9165b45b7948c60273e0b72fce0a64eb9 # v1.4.7
        with:
          cwd: ./amplify-js
          publish: yarn publish:preid
          createGithubReleases: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
          PREID: ${{ needs.parse-preid.outputs.preid }}
