{"version":3,"file":"auth.decorator.js","sourceRoot":"","sources":["../../../src/providers/auth.decorator.ts"],"names":[],"mappings":"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","sourcesContent":["import { Subject } from 'rxjs/Subject';\nimport Amplify, { Logger, Hub } from '@aws-amplify/core';\nimport { AuthState } from './auth.state';\nimport * as _ from 'lodash';\n\nconst logger = new Logger('AuthDecorator');\n\nfunction check(authState: Subject<AuthState>, Auth) {\n\t// check for current authenticated user to init authState\n\tAuth.currentAuthenticatedUser()\n\t\t.then(user => {\n\t\t\tlogger.debug('has authenticated user', user);\n\t\t\tauthState.next({ state: 'signedIn', user });\n\t\t})\n\t\t.catch(err => {\n\t\t\tlogger.debug('no authenticated user', err);\n\t\t\tauthState.next({ state: 'signedOut', user: null });\n\t\t});\n}\n\nfunction listen(authState: Subject<AuthState>) {\n\tconst config = Amplify.configure(null);\n\tif (_.has(config, 'Auth.oauth')) {\n\t\tHub.listen(\n\t\t\t'auth',\n\t\t\t{\n\t\t\t\tonHubCapsule: capsule => {\n\t\t\t\t\tconst { channel, payload } = capsule;\n\t\t\t\t\tif (channel === 'auth') {\n\t\t\t\t\t\tconst { username } = payload.data;\n\t\t\t\t\t\tlogger.debug('authentication oauth event', payload);\n\t\t\t\t\t\tauthState.next({ state: payload.event, user: { username } });\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t},\n\t\t\t'angularAuthListener'\n\t\t);\n\t}\n}\n\nfunction decorateSignIn(authState: Subject<AuthState>, Auth) {\n\tconst _signIn = Auth.signIn;\n\tAuth.signIn = (username: string, password: string): Promise<any> => {\n\t\treturn _signIn\n\t\t\t.call(Auth, username, password)\n\t\t\t.then(user => {\n\t\t\t\tlogger.debug('signIn success');\n\t\t\t\tif (!user.challengeName) {\n\t\t\t\t\tauthState.next({ state: 'signedIn', user });\n\t\t\t\t\treturn user;\n\t\t\t\t}\n\n\t\t\t\tlogger.debug('signIn challenge: ' + user.challengeName);\n\t\t\t\tif (user.challengeName === 'NEW_PASSWORD_REQUIRED') {\n\t\t\t\t\tauthState.next({ state: 'requireNewPassword', user });\n\t\t\t\t} else if (user.challengeName === 'MFA_SETUP') {\n\t\t\t\t\tauthState.next({ state: 'setupMFA', user });\n\t\t\t\t} else if (\n\t\t\t\t\tuser.challengeName === 'SMS_MFA' ||\n\t\t\t\t\tuser.challengeName === 'SOFTWARE_TOKEN_MFA'\n\t\t\t\t) {\n\t\t\t\t\tauthState.next({ state: 'confirmSignIn', user });\n\t\t\t\t} else {\n\t\t\t\t\tlogger.debug(\n\t\t\t\t\t\t'warning: unhandled challengeName ' + user.challengeName\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\treturn user;\n\t\t\t})\n\t\t\t.catch(err => {\n\t\t\t\tlogger.debug('signIn error', err);\n\t\t\t\tthrow err;\n\t\t\t});\n\t};\n}\n\nfunction decorateSignOut(authState: Subject<AuthState>, Auth) {\n\tconst _signOut = Auth.signOut;\n\tAuth.signOut = (): Promise<any> => {\n\t\treturn _signOut\n\t\t\t.call(Amplify.Auth)\n\t\t\t.then(data => {\n\t\t\t\tlogger.debug('signOut success');\n\t\t\t\tauthState.next({ state: 'signedOut', user: null });\n\t\t\t\treturn data;\n\t\t\t})\n\t\t\t.catch(err => {\n\t\t\t\tlogger.debug('signOut error', err);\n\t\t\t\tthrow err;\n\t\t\t});\n\t};\n}\n\nfunction decorateSignUp(authState: Subject<AuthState>, Auth) {\n\tconst _signUp = Auth.signUp;\n\tAuth.signUp = (\n\t\tusername: string,\n\t\tpassword: string,\n\t\temail: string,\n\t\tphone_number: string\n\t): Promise<any> => {\n\t\treturn _signUp\n\t\t\t.call(Auth, username, password, email, phone_number)\n\t\t\t.then(data => {\n\t\t\t\tlogger.debug('signUp success');\n\t\t\t\tauthState.next({ state: 'confirmSignUp', user: { username } });\n\t\t\t\treturn data;\n\t\t\t})\n\t\t\t.catch(err => {\n\t\t\t\tlogger.debug('signUp error', err);\n\t\t\t\tthrow err;\n\t\t\t});\n\t};\n}\n\nfunction decorateConfirmSignUp(authState: Subject<AuthState>, Auth) {\n\tconst _confirmSignUp = Auth.confirmSignUp;\n\tAuth.confirmSignUp = (username: string, code: string): Promise<any> => {\n\t\treturn _confirmSignUp\n\t\t\t.call(Auth, username, code)\n\t\t\t.then(data => {\n\t\t\t\tlogger.debug('confirmSignUp success');\n\t\t\t\tauthState.next({ state: 'signIn', user: { username } });\n\t\t\t\treturn data;\n\t\t\t})\n\t\t\t.catch(err => {\n\t\t\t\tlogger.debug('confirmSignUp error', err);\n\t\t\t\tthrow err;\n\t\t\t});\n\t};\n}\n\nexport function authDecorator(authState: Subject<AuthState>, authModule) {\n\tcheck(authState, authModule);\n\tlisten(authState);\n\tdecorateSignIn(authState, authModule);\n\tdecorateSignOut(authState, authModule);\n\tdecorateSignUp(authState, authModule);\n\tdecorateConfirmSignUp(authState, authModule);\n}\n"]}